<html>

<head>
  <style>
    body {
      background-color: #1D1D24;
    }

    #progress-text {
      position: absolute;
      top: 16px;
      left: 16px;
      width: calc(50% - 16px - 16px);
    }

    #progress-text-percentage {
      font-family: Roboto, sans-serif;
      font-weight: 700;
      font-size: 24px;
      line-height: 32px;
      color: #FFFFFF;
    }

    #progress-text-status {
      font-family: Roboto, sans-serif;
      font-weight: 700;
      font-size: 17px;
      line-height: 24px;
      color: #FFFFFF;
    }

    #progress-text-filename {
      font-family: Roboto, sans-serif;
      font-weight: 500;
      font-size: 14px;
      line-height: 20px;
      color: #FFFFFF;
      opacity: 0.5;
    }

    #progress-image {
      position: absolute;
      right: 16px;
      top: 16px;
      width: 90px;
      height: 90px;
      background-color: #2F2F37;
      background-size: contain;
      border-radius: 5px;
    }

    #progress-bar {
      position: absolute;
      top: calc(16px + 90px + 16px);
      left: 16px;
      width: calc(100% - 16px - 16px);
      height: 8px;
      background-color: #44444B;
      border-radius: 4px;
      overflow: hidden;
    }

    #progress-bar-fill {
      height: 100%;
      background-color: #5CBC57;
      border-radius: 4px;
    }

    #controls {
      position: absolute;
      left: 16px;
      right: 16px;
      bottom: 16px;

      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
    }

    #controls>.control {
      background-color: #44444A;
      height: 40px;
      border-radius: 10px;
    }
  </style>
</head>

<body class="homey-widget">

  <div id="progress-text">
    <div id="progress-text-percentage">44%</div>
    <div id="progress-text-status">Printing...</div>
    <div id="progress-text-filename">benchy_titanic.3mf</div>
  </div>

  <div id="progress-bar">
    <div
      id="progress-bar-fill"
      style="width: 44%;"
    ></div>
  </div>

  <div id="progress-image"></div>

  <div id="controls">
    <div
      id="controls-pause"
      class="control"
    ></div>
    <div
      id="controls-stop"
      class="control"
    ></div>
    <div
      id="controls-light"
      class="control"
    ></div>
    <div
      id="controls-todo"
      class="control"
    ></div>
    <div
      id="controls-fan"
      class="control"
    ></div>
  </div>

  <script type="text/javascript">
    function onHomeyReady(Homey) {
      let currentJobId = null;

      function getStatus() {
        const { device } = Homey.getSettings();
        Homey.api('GET', `/status?deviceId=${device.deviceId}`, {})
          .then(({
            progressPercentage,
            progressFilename,
            progressStatus,
            jobId,
          }) => {
            document.getElementById('progress-text-filename').innerText = progressFilename;
            document.getElementById('progress-text-status').innerText = progressStatus;
            document.getElementById('progress-text-percentage').innerText = `${progressPercentage}%`;
            document.getElementById('progress-bar-fill').style.width = `${progressPercentage}%`;

            if (jobId !== currentJobId) {
              Homey.api('GET', `/image?deviceId=${device.deviceId}`, {})
                .then(imageString => {
                  document.getElementById('progress-image').style.backgroundImage = `url(${imageString})`;
                  currentJobId = jobId;
                })
                .catch(console.error);
            }
          })
          .catch(console.error)
          .finally(() => {
            Homey.ready();
          });
      };

      getStatus();
      setInterval(getStatus, 1000);
    }
  </script>
</body>

</html>